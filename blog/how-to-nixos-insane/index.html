<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />

    <link href="/styles.css" rel="stylesheet" />

    <link rel="preconnect" href="https://fonts.bunny.net" />
    <link
      href="https://fonts.bunny.net/css?family=space-grotesk:400,700"
      rel="stylesheet"
    />

    <link rel="preconnect" href="https://rsms.me/" />
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />

    
    <link
      rel="alternate"
      type="application/atom+xml"
      title="RSS"
      href="https://happens.lol/atom.xml"
    />
    

    <!-- Title -->
      

    <title> How to use NixOS without going insane - happens, lol </title>
    <meta property="og:title" content="How to use NixOS without going insane - happens, lol" />

    <meta
      property="og:url"
      content="https:&#x2F;&#x2F;happens.lol&#x2F;blog&#x2F;how-to-nixos-insane&#x2F;"
    />
    <meta
      property="og:type"
      content="article"
    />

    <script>
      const getMode = () =>
        localStorage.theme === "dark" ||
        (!("theme" in localStorage) &&
          window.matchMedia("(prefers-color-scheme: dark)").matches)
          ? "dark"
          : "light";

      const updateModeIcon = (mode) => {
        const light = document.getElementById("mode-light");
        const dark = document.getElementById("mode-dark");
        if (light == null || dark == null) return;

        const isDark = mode === "dark";
        light.classList.toggle("hidden", !isDark);
        dark.classList.toggle("hidden", isDark);
      };

      const setMode = (mode) => {
        const target = mode ?? getMode();
        if (mode != null) localStorage.theme = target;
        document.documentElement.classList.toggle("dark", target === "dark");
        updateModeIcon(target);
      };

      const toggleMode = () => {
        const current = getMode();
        if (current === "dark") setMode("light");
        else setMode("dark");
      };

      setMode();
    </script>
  </head>

  <body
    class="w-full min-h-screen dark:bg-neutral-900 dark:text-neutral-100 flex flex-col items-center py-8"
  >
    <header
      class="w-full flex mb-16 px-8 flex justify-between items-center max-w-content"
    >
      <h1>
        <a href="/" class="page-title">happens, lol</a>
      </h1>

      <div class="flex items-center gap-2">
        <a
          href="https://github.com/happenslol"
          class="social-link hover:text-lime-600"
        >
          <svg
            class="w-8 h-8"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentcolor"
          >
            <path
              d="M12.001 2C6.47598 2 2.00098 6.475 2.00098 12C2.00098 16.425 4.86348 20.1625 8.83848 21.4875C9.33848 21.575 9.52598 21.275 9.52598 21.0125C9.52598 20.775 9.51348 19.9875 9.51348 19.15C7.00098 19.6125 6.35098 18.5375 6.15098 17.975C6.03848 17.6875 5.55098 16.8 5.12598 16.5625C4.77598 16.375 4.27598 15.9125 5.11348 15.9C5.90098 15.8875 6.46348 16.625 6.65098 16.925C7.55098 18.4375 8.98848 18.0125 9.56348 17.75C9.65098 17.1 9.91348 16.6625 10.201 16.4125C7.97598 16.1625 5.65098 15.3 5.65098 11.475C5.65098 10.3875 6.03848 9.4875 6.67598 8.7875C6.57598 8.5375 6.22598 7.5125 6.77598 6.1375C6.77598 6.1375 7.61348 5.875 9.52598 7.1625C10.326 6.9375 11.176 6.825 12.026 6.825C12.876 6.825 13.726 6.9375 14.526 7.1625C16.4385 5.8625 17.276 6.1375 17.276 6.1375C17.826 7.5125 17.476 8.5375 17.376 8.7875C18.0135 9.4875 18.401 10.375 18.401 11.475C18.401 15.3125 16.0635 16.1625 13.8385 16.4125C14.201 16.725 14.5135 17.325 14.5135 18.2625C14.5135 19.6 14.501 20.675 14.501 21.0125C14.501 21.275 14.6885 21.5875 15.1885 21.4875C19.259 20.1133 21.9999 16.2963 22.001 12C22.001 6.475 17.526 2 12.001 2Z"
            ></path>
          </svg>
        </a>

        <a
          href="https://bsky.app/profile/happens.lol"
          class="social-link hover:text-blue-300"
        >
          <svg
            class="w-8 h-8"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              d="M4.90727 3.43929C5.61594 3.56009 6.44016 3.94139 7.48302 4.68685C9.27977 5.97119 10.7687 7.73907 12 9.56361C13.2313 7.73907 14.7202 5.97119 16.517 4.68685C17.5598 3.94139 18.3841 3.56009 19.0927 3.43929C19.8605 3.3084 20.3825 3.50358 20.7082 3.63931C21.7166 4.05956 22 5.22508 22 6.21461C22 6.41649 21.9144 7.5166 21.8148 8.57508C21.7634 9.12088 21.7057 9.68306 21.6486 10.1515C21.5963 10.5804 21.5337 11.0321 21.4587 11.2849C21.1161 12.4395 20.3965 13.2618 19.508 13.8021C20.4453 14.5092 20.7854 15.6583 20.4359 16.7856C19.8393 18.71 17.6991 21.1833 15.6005 21.4037C13.8281 21.5898 12.6662 20.0794 12 18.6449C11.3338 20.0794 10.1719 21.5898 8.39954 21.4037C6.30095 21.1833 4.1607 18.71 3.56408 16.7856C3.21457 15.6583 3.55466 14.5092 4.49197 13.8021C3.60345 13.2618 2.88394 12.4395 2.54132 11.2849C2.46631 11.0321 2.40367 10.5804 2.35139 10.1515C2.29429 9.68306 2.23658 9.12088 2.18521 8.57508C2.08559 7.5166 2 6.41649 2 6.21461C2 5.22508 2.28343 4.05956 3.29182 3.63931C3.61753 3.50358 4.13949 3.3084 4.90727 3.43929ZM4.04911 6.91709C4.11331 7.73486 4.22889 9.02507 4.33669 9.90947C4.36927 10.1767 4.39214 10.4536 4.45863 10.7156C4.85637 12.056 6.38779 12.7978 8.14506 12.603C8.68686 12.5429 9.17695 12.9278 9.24697 13.4684C9.31698 14.009 8.94113 14.5061 8.40191 14.586C7.64608 14.6981 5.08656 14.9425 5.47438 16.1934C5.8312 17.3443 7.32212 19.2796 8.60842 19.4146C9.53606 19.5121 10.1084 18.0211 10.3741 17.3697C10.6489 16.6958 10.8622 15.9903 11.0417 15.3885C11.1681 14.9648 11.5578 14.6744 12 14.6744C12.4422 14.6744 12.8319 14.9648 12.9583 15.3885C13.1378 15.9903 13.3511 16.6958 13.6259 17.3697C13.8916 18.0211 14.4639 19.5121 15.3916 19.4146C16.6779 19.2796 18.1688 17.3443 18.5256 16.1934C18.9134 14.9425 16.3539 14.6981 15.5981 14.586C15.0589 14.5061 14.683 14.009 14.753 13.4684C14.8231 12.9278 15.3131 12.5429 15.8549 12.603C17.6122 12.7978 19.1436 12.0563 19.5413 10.7159C19.61 10.45 19.63 10.18 19.6633 9.90948C19.7711 9.02507 19.8867 7.73486 19.9509 6.91709C19.9876 6.44922 20.1985 5.27964 19.4288 5.41084C19.1429 5.45959 18.6059 5.65205 17.68 6.31391C15.7374 7.70252 13.9749 9.82666 12.891 11.954C12.7203 12.289 12.376 12.5 12 12.5C11.624 12.5 11.2797 12.289 11.109 11.954C10.0251 9.82666 8.26258 7.70252 6.31998 6.31391C5.39406 5.65205 4.85713 5.45959 4.57117 5.41084C3.7874 5.27724 4.01205 6.44504 4.04911 6.91709Z"
            ></path>
          </svg>
        </a>

        <button
          class="cursor-pointer w-8 h-8 dark:hover:text-yellow-600 hover:text-purple-400 transition-colors"
          id="mode-toggle"
          onclick="toggleMode()"
        >
          <svg
            id="mode-light"
            class="w-8 h-8 hidden"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 256 256"
          >
            <path
              fill="currentColor"
              d="M120 40V16a8 8 0 0 1 16 0v24a8 8 0 0 1-16 0m8 24a64 64 0 1 0 64 64a64.07 64.07 0 0 0-64-64m-69.66 5.66a8 8 0 0 0 11.32-11.32l-16-16a8 8 0 0 0-11.32 11.32Zm0 116.68l-16 16a8 8 0 0 0 11.32 11.32l16-16a8 8 0 0 0-11.32-11.32M192 72a8 8 0 0 0 5.66-2.34l16-16a8 8 0 0 0-11.32-11.32l-16 16A8 8 0 0 0 192 72m5.66 114.34a8 8 0 0 0-11.32 11.32l16 16a8 8 0 0 0 11.32-11.32ZM48 128a8 8 0 0 0-8-8H16a8 8 0 0 0 0 16h24a8 8 0 0 0 8-8m80 80a8 8 0 0 0-8 8v24a8 8 0 0 0 16 0v-24a8 8 0 0 0-8-8m112-88h-24a8 8 0 0 0 0 16h24a8 8 0 0 0 0-16"
            />
          </svg>

          <svg
            id="mode-dark"
            xmlns="http://www.w3.org/2000/svg"
            class="w-8 h-8 hidden"
            viewBox="0 0 256 256"
          >
            <path
              fill="currentColor"
              d="M236.37 139.4a12 12 0 0 0-12-3A84.07 84.07 0 0 1 119.6 31.59a12 12 0 0 0-15-15a108.86 108.86 0 0 0-54.91 38.48A108 108 0 0 0 136 228a107.1 107.1 0 0 0 64.93-21.69a108.86 108.86 0 0 0 38.44-54.94a12 12 0 0 0-3-11.97m-49.88 47.74A84 84 0 0 1 68.86 69.51a84.9 84.9 0 0 1 23.41-21.22Q92 52.13 92 56a108.12 108.12 0 0 0 108 108q3.87 0 7.71-.27a84.8 84.8 0 0 1-21.22 23.41"
            />
          </svg>
        </button>
      </div>
    </header>

    <main class="flex-1 flex flex-col w-full items-center">
      
<div class="max-w-content w-full px-8">
  <p class="text-neutral-500 text-sm mb-2">2025-07-13</p>
  <h1 class="text-4xl font-bold mb-8">How to use NixOS without going insane</h1>

  <article class="prose"><p>I've been using NixOS for a while now, and had my fair share of troubles with it. My main usecases for it are:</p>
<ul>
<li>I want my different machines (home, work, laptop) to stay synchronized when it comes to config and installed tools.</li>
<li>I want to be able to wipe machines and reinstall them easily without having to do a ton of setup.</li>
<li>I want to be able to easily add new machines and have them set up in the same way as my other machines.</li>
</ul>
<p>After a lot of trial and error, I think I've landed on a good solution to achieve all of this while working around common issues that NixOS tends to have in the real world. In this post, I'll try to outline how I do things and explain how you can adapt my config for yourself.</p>
<div
  class="border-2 border-blue-300 bg-blue-100 dark:border-neutral-600 dark:bg-neutral-800 px-5 pt-4 mb-8 mt-4 rounded-lg"
>
  <p>Note that this is not meant as a general introduction to NixOS - There are lots of great tutorials already. I'm only detailing how I use NixOS to achieve my goals with relatively little effort here.</p>
<p>I'll omit a lot of settings I have in my config if they are specific to my needs. You can have a look at my full config <a href="https://github.com/happens/flake">here</a>. Feel free to shoot me a message if you have any questions!</p>

</div>
<h2 id="keeping-it-simple">Keeping it Simple</h2>
<p>When looking at other NixOS configs, one thing that I see a lot is deeply nested directory structure, seperate files for every package that is installed, and custom modules with options that can be configured for every host.</p>
<p>This has many advantages and offers a lot of flexibility when it comes to configuring your machines. It also introduces a big maintenance burden and makes adding new packages harder, since you'll always think about the configuration API you'll have to write for yourself. Since I want all my machine configs to be <em>very</em> similar, I do away with all of that and try to keep my config as straightforward and flat as possible.</p>
<p>Here's what it looks like:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">~/.flake
</span><span style="color:#bf616a;">├──</span><span> config/          </span><span style="color:#65737e;"># Dotfiles
</span><span style="color:#bf616a;">│</span><span>   ├── nvim/
</span><span style="color:#bf616a;">│</span><span>   ├── zsh/
</span><span style="color:#bf616a;">│</span><span>   ├── direnv/
</span><span style="color:#bf616a;">│</span><span>   ├── git/
</span><span style="color:#bf616a;">│</span><span>   └── ...
</span><span style="color:#bf616a;">├──</span><span> hosts/           </span><span style="color:#65737e;"># Host-specific config
</span><span style="color:#bf616a;">│</span><span>   ├── mira/
</span><span style="color:#bf616a;">│</span><span>   │   ├── config/
</span><span style="color:#bf616a;">│</span><span>   │   ├── configuration.nix
</span><span style="color:#bf616a;">│</span><span>   │   └── hardware-configuration.nix
</span><span style="color:#bf616a;">│</span><span>   ├── hei/
</span><span style="color:#bf616a;">│</span><span>   │   ├── config/
</span><span style="color:#bf616a;">│</span><span>   │   ├── configuration.nix
</span><span style="color:#bf616a;">│</span><span>   │   └── hardware-configuration.nix
</span><span style="color:#bf616a;">│</span><span>   └── ...
</span><span style="color:#bf616a;">├──</span><span> flake.nix        </span><span style="color:#65737e;"># Flake inputs and plumbing
</span><span style="color:#bf616a;">├──</span><span> home.nix         </span><span style="color:#65737e;"># Home-manager configuration
</span><span style="color:#bf616a;">├──</span><span> system.nix       </span><span style="color:#65737e;"># General NixOS configuration
</span><span style="color:#bf616a;">├──</span><span> overlay.nix      </span><span style="color:#65737e;"># nixpkgs customization
</span><span style="color:#bf616a;">├──</span><span> packages.nix     </span><span style="color:#65737e;"># List of all installed packages
</span><span style="color:#bf616a;">├──</span><span> devshells.nix    </span><span style="color:#65737e;"># Global shells for development
</span><span style="color:#bf616a;">└──</span><span> justfile         </span><span style="color:#65737e;"># Recipes for formatting, building the config, etc.
</span></code></pre>
<p>Let's go through the nix files one by one.</p>
<h3 id="flake-nix"><code>flake.nix</code></h3>
<p>This is the entrypoint.</p>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span>{
</span><span>  </span><span style="color:#d08770;">description </span><span>= &quot;</span><span style="color:#a3be8c;">system config</span><span>&quot;;
</span><span>
</span><span>  </span><span style="color:#d08770;">inputs </span><span>= {
</span><span>    </span><span style="color:#d08770;">nixpkgs</span><span>.</span><span style="color:#d08770;">url </span><span>= &quot;</span><span style="color:#a3be8c;">nixpkgs/nixos-unstable</span><span>&quot;;
</span><span>
</span><span>    </span><span style="color:#65737e;"># nixos-hardware provides some predefined configuration for specific laptop
</span><span>    </span><span style="color:#65737e;"># models, CPUs and so on.
</span><span>    </span><span style="color:#d08770;">nixos-hardware</span><span>.</span><span style="color:#d08770;">url </span><span>= &quot;</span><span style="color:#a3be8c;">github:NixOS/nixos-hardware/master</span><span>&quot;;
</span><span>
</span><span>    </span><span style="color:#65737e;"># Use home-manager as a flake
</span><span>    </span><span style="color:#d08770;">home-manager </span><span>= {
</span><span>      </span><span style="color:#d08770;">url </span><span>= &quot;</span><span style="color:#a3be8c;">github:nix-community/home-manager</span><span>&quot;;
</span><span>      </span><span style="color:#d08770;">inputs</span><span>.</span><span style="color:#d08770;">nixpkgs</span><span>.</span><span style="color:#d08770;">follows </span><span>= &quot;</span><span style="color:#a3be8c;">nixpkgs</span><span>&quot;;
</span><span>    };
</span><span>
</span><span>    </span><span style="color:#65737e;"># Everything after this point is optional.
</span><span>
</span><span>    </span><span style="color:#65737e;"># I want to use neovim nightly instead of the latest stable version
</span><span>    </span><span style="color:#d08770;">neovim-nightly-overlay </span><span>= {
</span><span>      </span><span style="color:#d08770;">url </span><span>= &quot;</span><span style="color:#a3be8c;">github:nix-community/neovim-nightly-overlay</span><span>&quot;;
</span><span>      </span><span style="color:#d08770;">inputs</span><span>.</span><span style="color:#d08770;">nixpkgs</span><span>.</span><span style="color:#d08770;">follows </span><span>= &quot;</span><span style="color:#a3be8c;">nixpkgs</span><span>&quot;;
</span><span>    };
</span><span>
</span><span>    </span><span style="color:#65737e;"># Speed up nixpkgs searches by using a prebuilt database
</span><span>    </span><span style="color:#d08770;">nix-index-database </span><span>= {
</span><span>      </span><span style="color:#d08770;">url </span><span>= &quot;</span><span style="color:#a3be8c;">github:nix-community/nix-index-database</span><span>&quot;;
</span><span>      </span><span style="color:#d08770;">inputs</span><span>.</span><span style="color:#d08770;">nixpkgs</span><span>.</span><span style="color:#d08770;">follows </span><span>= &quot;</span><span style="color:#a3be8c;">nixpkgs</span><span>&quot;;
</span><span>    };
</span><span>
</span><span>    </span><span style="color:#65737e;"># More custom packages or overlays you might want to install go here.
</span><span>    </span><span style="color:#65737e;"># For example, I have a few tools that I&#39;ve written myself, which I add as
</span><span>    </span><span style="color:#65737e;"># inputs here:
</span><span>    </span><span style="color:#d08770;">serve </span><span>= {
</span><span>      </span><span style="color:#d08770;">url </span><span>= &quot;</span><span style="color:#a3be8c;">github:happenslol/serve</span><span>&quot;;
</span><span>      </span><span style="color:#d08770;">inputs</span><span>.</span><span style="color:#d08770;">nixpkgs</span><span>.</span><span style="color:#d08770;">follows </span><span>= &quot;</span><span style="color:#a3be8c;">nixpkgs</span><span>&quot;;
</span><span>    };
</span><span>  };
</span><span>
</span><span>  </span><span style="color:#d08770;">outputs </span><span>= inputs @ </span><span style="color:#8fa1b3;">{
</span><span>    nixpkgs,
</span><span>    home-manager,
</span><span>    nix-index-database,
</span><span>    ...
</span><span>  </span><span style="color:#8fa1b3;">}</span><span>: </span><span style="color:#b48ead;">let
</span><span>    </span><span style="color:#65737e;"># All my hosts are linux machines - This could be added as a parameter to
</span><span>    </span><span style="color:#65737e;"># `mkHost` if yours aren&#39;t.
</span><span>    </span><span style="color:#d08770;">system </span><span>= &quot;</span><span style="color:#a3be8c;">x86_64-linux</span><span>&quot;;
</span><span>    </span><span style="color:#d08770;">username </span><span>= &quot;</span><span style="color:#a3be8c;">happens</span><span>&quot;;
</span><span>
</span><span>    </span><span style="color:#65737e;"># Add my own overlays and overlays provided by flakes.
</span><span>    </span><span style="color:#d08770;">overlays </span><span>= [
</span><span>      (</span><span style="color:#96b5b4;">import </span><span style="color:#a3be8c;">./overlay.nix</span><span>)
</span><span>      </span><span style="color:#bf616a;">inputs</span><span>.</span><span style="color:#bf616a;">neovim-nightly-overlay</span><span>.</span><span style="color:#bf616a;">overlays</span><span>.</span><span style="color:#bf616a;">default
</span><span>    ];
</span><span>
</span><span>    </span><span style="color:#65737e;"># Apply the overlays and allow unfree packages (slack, zoom, discord, ...)
</span><span>    </span><span style="color:#d08770;">pkgs </span><span>= </span><span style="color:#96b5b4;">import </span><span style="color:#bf616a;">nixpkgs </span><span>{
</span><span>      </span><span style="color:#b48ead;">inherit </span><span style="color:#d08770;">system</span><span>;
</span><span>      </span><span style="color:#d08770;">overlays </span><span>= </span><span style="color:#bf616a;">overlays</span><span>;
</span><span>      </span><span style="color:#d08770;">config</span><span>.</span><span style="color:#d08770;">allowUnfree </span><span>= </span><span style="color:#d08770;">true</span><span>;
</span><span>    };
</span><span>
</span><span>    </span><span style="color:#65737e;"># This creates the actual host configuration. Instead of passing lots of
</span><span>    </span><span style="color:#65737e;"># options for every host here, this includes per-host configuration files.
</span><span>    </span><span style="color:#65737e;">#
</span><span>    </span><span style="color:#65737e;"># The stateVersion can be different per host, and basically just defines
</span><span>    </span><span style="color:#65737e;"># what version of NixOS was current when you installed the system first.
</span><span>    </span><span style="color:#d08770;">mkHost </span><span>= </span><span style="color:#8fa1b3;">{ </span><span>hostname, stateVersion </span><span style="color:#8fa1b3;">}</span><span>: (</span><span style="color:#bf616a;">nixpkgs</span><span>.</span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">nixosSystem </span><span>{
</span><span>      </span><span style="color:#b48ead;">inherit </span><span style="color:#d08770;">system pkgs</span><span>;
</span><span>
</span><span>      </span><span style="color:#65737e;"># Pass these args to every module.
</span><span>      </span><span style="color:#d08770;">specialArgs </span><span>= {</span><span style="color:#b48ead;">inherit </span><span style="color:#d08770;">inputs stateVersion hostname username system</span><span>;};
</span><span>
</span><span>      </span><span style="color:#d08770;">modules </span><span>= [
</span><span>        </span><span style="color:#65737e;"># Include our general system config.
</span><span>        </span><span style="color:#a3be8c;">./system.nix
</span><span>
</span><span>        </span><span style="color:#65737e;"># As mentioned above, we include the host-specific config as modules
</span><span>        </span><span style="color:#65737e;"># here from the hosts directory.
</span><span>        (</span><span style="color:#a3be8c;">./. </span><span>+ &quot;</span><span style="color:#a3be8c;">/hosts/</span><span style="font-style:italic;color:#ab7967;">${</span><span style="font-style:italic;color:#bf616a;">hostname</span><span style="font-style:italic;color:#ab7967;">}</span><span style="color:#a3be8c;">/hardware-configuration.nix</span><span>&quot;)
</span><span>        (</span><span style="color:#a3be8c;">./. </span><span>+ &quot;</span><span style="color:#a3be8c;">/hosts/</span><span style="font-style:italic;color:#ab7967;">${</span><span style="font-style:italic;color:#bf616a;">hostname</span><span style="font-style:italic;color:#ab7967;">}</span><span style="color:#a3be8c;">/configuration.nix</span><span>&quot;)
</span><span>
</span><span>        </span><span style="color:#65737e;"># All inputs that provide extra modules go here.
</span><span>        </span><span style="color:#bf616a;">nix-index-database</span><span>.</span><span style="color:#bf616a;">nixosModules</span><span>.</span><span style="color:#bf616a;">nix-index
</span><span>        </span><span style="color:#bf616a;">home-manager</span><span>.</span><span style="color:#bf616a;">nixosModules</span><span>.</span><span style="color:#bf616a;">home-manager
</span><span>
</span><span>        </span><span style="color:#65737e;"># Include our home-manager configuration.
</span><span>        {
</span><span>          </span><span style="color:#d08770;">home-manager </span><span>= {
</span><span>            </span><span style="color:#65737e;"># Make sure we use the same nixpkgs as the rest of the config.
</span><span>            </span><span style="color:#d08770;">useGlobalPkgs </span><span>= </span><span style="color:#d08770;">true</span><span>;
</span><span>
</span><span>            </span><span style="color:#65737e;"># This allows us to install all of our packages through
</span><span>            </span><span style="color:#65737e;"># home-manager, instead of globally.
</span><span>            </span><span style="color:#d08770;">useUserPackages </span><span>= </span><span style="color:#d08770;">true</span><span>;
</span><span>
</span><span>            </span><span style="color:#65737e;"># Same as above - these will be available in our `home.nix`.
</span><span>            </span><span style="color:#d08770;">extraSpecialArgs </span><span>= {</span><span style="color:#b48ead;">inherit </span><span style="color:#d08770;">inputs stateVersion hostname system username</span><span>;};
</span><span>            </span><span style="color:#d08770;">users</span><span>.</span><span style="font-style:italic;color:#ab7967;">${</span><span style="font-style:italic;color:#bf616a;">username</span><span style="font-style:italic;color:#ab7967;">} </span><span>= </span><span style="color:#96b5b4;">import </span><span style="color:#a3be8c;">./home.nix</span><span>;
</span><span>          };
</span><span>        }
</span><span>      ];
</span><span>    });
</span><span>  </span><span style="color:#b48ead;">in </span><span>{
</span><span>    </span><span style="color:#d08770;">nixosConfigurations </span><span>= {
</span><span>      </span><span style="color:#d08770;">mira </span><span>= </span><span style="color:#bf616a;">mkHost </span><span>{
</span><span>        </span><span style="color:#d08770;">hostname </span><span>= &quot;</span><span style="color:#a3be8c;">mira</span><span>&quot;;
</span><span>        </span><span style="color:#d08770;">stateVersion </span><span>= &quot;</span><span style="color:#a3be8c;">24.11</span><span>&quot;;
</span><span>      };
</span><span>      </span><span style="color:#d08770;">hei </span><span>= </span><span style="color:#bf616a;">mkHost </span><span>{
</span><span>        </span><span style="color:#d08770;">hostname </span><span>= &quot;</span><span style="color:#a3be8c;">hei</span><span>&quot;;
</span><span>        </span><span style="color:#d08770;">stateVersion </span><span>= &quot;</span><span style="color:#a3be8c;">24.11</span><span>&quot;;
</span><span>      };
</span><span>
</span><span>      </span><span style="color:#65737e;"># More hosts...
</span><span>    };
</span><span>
</span><span>    </span><span style="color:#65737e;"># Adding devshells here allows us to use them like this:
</span><span>    </span><span style="color:#65737e;"># `nix develop ~/.flake#&lt;name&gt;`
</span><span>    </span><span style="color:#d08770;">devShells</span><span>.</span><span style="font-style:italic;color:#ab7967;">${</span><span style="font-style:italic;color:#bf616a;">system</span><span style="font-style:italic;color:#ab7967;">} </span><span>= </span><span style="color:#96b5b4;">import </span><span style="color:#a3be8c;">./devshells.nix </span><span style="color:#bf616a;">pkgs</span><span>;
</span><span>  };
</span><span>}
</span></code></pre>
<p>That was a lot! But with all of this set up, the rest of the files are a lot shorter.</p>
<h3 id="system-nix"><code>system.nix</code></h3>
<p>These are configuration options that apply to every machine. I'll just show a few options that are non-obvious here or that I find especially useful here.</p>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#8fa1b3;">{ </span><span>pkgs, stateVersion, username </span><span style="color:#8fa1b3;">}</span><span>: {
</span><span>  </span><span style="color:#d08770;">system </span><span>= {</span><span style="color:#b48ead;">inherit </span><span style="color:#d08770;">stateVersion</span><span>;};
</span><span>
</span><span>  </span><span style="color:#d08770;">nix </span><span>= {
</span><span>    </span><span style="color:#65737e;"># Make sure we use the same nixpkgs version as in this flake when we use
</span><span>    </span><span style="color:#65737e;"># `nix-shell -p`
</span><span>    </span><span style="color:#d08770;">registry</span><span>.</span><span style="color:#d08770;">nixkpgs</span><span>.</span><span style="color:#d08770;">flake </span><span>= </span><span style="color:#bf616a;">inputs</span><span>.</span><span style="color:#bf616a;">nixpkgs</span><span>;
</span><span>    </span><span style="color:#d08770;">nixPath </span><span>= [&quot;</span><span style="color:#a3be8c;">nixpkgs=</span><span style="font-style:italic;color:#ab7967;">${</span><span style="font-style:italic;color:#bf616a;">inputs</span><span style="font-style:italic;color:#c0c5ce;">.</span><span style="font-style:italic;color:#bf616a;">nixpkgs</span><span style="font-style:italic;color:#c0c5ce;">.</span><span style="font-style:italic;color:#bf616a;">outPath</span><span style="font-style:italic;color:#ab7967;">}</span><span>&quot;];
</span><span>
</span><span>    </span><span style="color:#65737e;"># Enable modern NixOS features
</span><span>    </span><span style="color:#d08770;">settings</span><span>.</span><span style="color:#d08770;">experimental-features </span><span>= [&quot;</span><span style="color:#a3be8c;">nix-command</span><span>&quot; &quot;</span><span style="color:#a3be8c;">flakes</span><span>&quot; &quot;</span><span style="color:#a3be8c;">pipe-operators</span><span>&quot;];
</span><span>  };
</span><span>
</span><span>  </span><span style="color:#d08770;">programs </span><span>= {
</span><span>    </span><span style="color:#65737e;"># Add systemwide programs here, e.g.:
</span><span>    </span><span style="color:#d08770;">command-not-found</span><span>.</span><span style="color:#d08770;">enable </span><span>= </span><span style="color:#d08770;">false</span><span>;
</span><span>    </span><span style="color:#d08770;">nix-index-database</span><span>.</span><span style="color:#d08770;">comma</span><span>.</span><span style="color:#d08770;">enable </span><span>= </span><span style="color:#d08770;">true</span><span>;
</span><span>    </span><span style="color:#d08770;">steam</span><span>.</span><span style="color:#d08770;">enable </span><span>= </span><span style="color:#d08770;">true</span><span>;
</span><span>
</span><span>    </span><span style="color:#65737e;"># More on this later. This allows running a lot of unpatched dynamic binaries.
</span><span>    </span><span style="color:#d08770;">nix-ld </span><span>= {
</span><span>      </span><span style="color:#d08770;">enable </span><span>= </span><span style="color:#d08770;">true</span><span>;
</span><span>      </span><span style="color:#d08770;">libraries </span><span>= </span><span style="color:#d08770;">builtins</span><span>.</span><span style="color:#bf616a;">concatLists </span><span>(</span><span style="color:#d08770;">builtins</span><span>.</span><span style="color:#bf616a;">attrValues </span><span>(</span><span style="color:#96b5b4;">import </span><span style="color:#a3be8c;">./ld.nix </span><span style="color:#bf616a;">pkgs</span><span>));
</span><span>    };
</span><span>  };
</span><span>
</span><span>  </span><span style="color:#d08770;">environment </span><span>= {
</span><span>    </span><span style="color:#65737e;"># Add packages that you want to be available no matter what here.
</span><span>    </span><span style="color:#d08770;">systemPackages </span><span>= </span><span style="color:#b48ead;">with </span><span style="color:#bf616a;">pkgs</span><span>; [</span><span style="color:#bf616a;">neovim curl kitty</span><span>];
</span><span>  };
</span><span>
</span><span>  </span><span style="color:#d08770;">services </span><span>= {
</span><span>    </span><span style="color:#65737e;"># Enable any services you want here, e.g.:
</span><span>    </span><span style="color:#d08770;">upower</span><span>.</span><span style="color:#d08770;">enable </span><span>= </span><span style="color:#d08770;">true</span><span>;
</span><span>    </span><span style="color:#d08770;">openssh</span><span>.</span><span style="color:#d08770;">enable </span><span>= </span><span style="color:#d08770;">true</span><span>;
</span><span>    </span><span style="color:#d08770;">dbus</span><span>.</span><span style="color:#d08770;">enable </span><span>= </span><span style="color:#d08770;">true</span><span>;
</span><span>  };
</span><span>
</span><span>  </span><span style="color:#65737e;"># Add the user. You can also add extra groups to the user here.
</span><span>  </span><span style="color:#d08770;">users</span><span>.</span><span style="color:#d08770;">users</span><span>.</span><span style="font-style:italic;color:#ab7967;">${</span><span style="font-style:italic;color:#bf616a;">username</span><span style="font-style:italic;color:#ab7967;">}</span><span>.</span><span style="color:#d08770;">isNormalUser </span><span>= </span><span style="color:#d08770;">true</span><span>;
</span><span>}
</span></code></pre>
<h3 id="home-nix"><code>home.nix</code></h3>
<p>This is where I install my packages, link my dotfiles, and configure home-manager.</p>
<p>The most important thing to note here is that we use <code>mkOutOfStoreSymlink</code> to link our dotfiles. This lets us create symlinks to our dotfiles in this repository instead of symlinks to the nix store, which would be read only. Additionally, changes to dotfiles don't require rebuilding NixOS to be applied. I didn't do this at first and it was really painful.</p>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#8fa1b3;">{ </span><span>config, pkgs, stateVersion, hostname, system </span><span style="color:#8fa1b3;">}</span><span>: </span><span style="color:#b48ead;">let
</span><span>  </span><span style="color:#d08770;">home </span><span>= &quot;</span><span style="color:#a3be8c;">/home/</span><span style="font-style:italic;color:#ab7967;">${</span><span style="font-style:italic;color:#bf616a;">username</span><span style="font-style:italic;color:#ab7967;">}</span><span>&quot;;
</span><span>
</span><span>  </span><span style="color:#65737e;"># See above.
</span><span>  </span><span style="color:#d08770;">dotfiles </span><span>= </span><span style="color:#bf616a;">config</span><span>.</span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">file</span><span>.</span><span style="color:#bf616a;">mkOutOfStoreSymlink </span><span>&quot;</span><span style="font-style:italic;color:#ab7967;">${</span><span style="font-style:italic;color:#bf616a;">home</span><span style="font-style:italic;color:#ab7967;">}</span><span style="color:#a3be8c;">/.flake/config</span><span>&quot;;
</span><span style="color:#b48ead;">in </span><span>{
</span><span>  </span><span style="color:#65737e;"># Enable home-manager
</span><span>  </span><span style="color:#d08770;">programs</span><span>.</span><span style="color:#d08770;">home-manager</span><span>.</span><span style="color:#d08770;">enable </span><span>= </span><span style="color:#d08770;">true</span><span>;
</span><span>
</span><span>  </span><span style="color:#d08770;">home </span><span>= {
</span><span>    </span><span style="color:#b48ead;">inherit </span><span style="color:#d08770;">stateVersion username</span><span>;
</span><span>    </span><span style="color:#d08770;">homeDirectory </span><span>= </span><span style="color:#bf616a;">home</span><span>;
</span><span>
</span><span>    </span><span style="color:#65737e;"># Install packages from `packages.nix`. I move around the structure here a
</span><span>    </span><span style="color:#65737e;"># bit so that file can be as simple as possible.
</span><span>    </span><span style="color:#d08770;">packages </span><span>=
</span><span>      (</span><span style="color:#d08770;">builtins</span><span>.</span><span style="color:#bf616a;">concatLists </span><span>(</span><span style="color:#d08770;">builtins</span><span>.</span><span style="color:#bf616a;">attrValues </span><span>(</span><span style="color:#96b5b4;">import </span><span style="color:#a3be8c;">./packages.nix </span><span style="color:#bf616a;">pkgs</span><span>)))
</span><span>      ++ (</span><span style="color:#d08770;">builtins</span><span>.</span><span style="color:#bf616a;">attrValues custom</span><span>);
</span><span>
</span><span>    </span><span style="color:#65737e;"># Link dotfiles that live outside of `~/.config`.
</span><span>    </span><span style="color:#d08770;">file </span><span>= {
</span><span>      &quot;</span><span style="color:#a3be8c;">.gitconfig</span><span>&quot;.</span><span style="color:#d08770;">source </span><span>= &quot;</span><span style="font-style:italic;color:#ab7967;">${</span><span style="font-style:italic;color:#bf616a;">dotfiles</span><span style="font-style:italic;color:#ab7967;">}</span><span style="color:#a3be8c;">/git/gitconfig</span><span>&quot;;
</span><span>      &quot;</span><span style="color:#a3be8c;">.ssh/config</span><span>&quot;.</span><span style="color:#d08770;">source </span><span>= &quot;</span><span style="font-style:italic;color:#ab7967;">${</span><span style="font-style:italic;color:#bf616a;">dotfiles</span><span style="font-style:italic;color:#ab7967;">}</span><span style="color:#a3be8c;">/ssh/config</span><span>&quot;;
</span><span>      </span><span style="color:#65737e;"># ...
</span><span>    };
</span><span>  };
</span><span>
</span><span>  </span><span style="color:#65737e;"># Link dotfiles inside `~/.config`.
</span><span>  </span><span style="color:#d08770;">xdg</span><span>.</span><span style="color:#d08770;">configFile </span><span>= {
</span><span>    &quot;</span><span style="color:#a3be8c;">nvim</span><span>&quot;.</span><span style="color:#d08770;">source </span><span>= &quot;</span><span style="font-style:italic;color:#ab7967;">${</span><span style="font-style:italic;color:#bf616a;">dotfiles</span><span style="font-style:italic;color:#ab7967;">}</span><span style="color:#a3be8c;">/nvim</span><span>&quot;;
</span><span>    &quot;</span><span style="color:#a3be8c;">kitty</span><span>&quot;.</span><span style="color:#d08770;">source </span><span>= &quot;</span><span style="font-style:italic;color:#ab7967;">${</span><span style="font-style:italic;color:#bf616a;">dotfiles</span><span style="font-style:italic;color:#ab7967;">}</span><span style="color:#a3be8c;">/kitty</span><span>&quot;;
</span><span>    </span><span style="color:#65737e;"># ...
</span><span>  };
</span><span>
</span><span>  </span><span style="color:#65737e;"># Add more home-manager configuration here.
</span><span>}
</span></code></pre>
<h3 id="packages-nix"><code>packages.nix</code></h3>
<p>This could be included in <code>home.nix</code> (and previously was), but I like being able to quickly install packages without having to go through my <code>home.nix</code> by just adding them here. It's also nice to just have a list of everything I expect to be installed.</p>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span>pkgs: {
</span><span>  </span><span style="color:#d08770;">pkgs </span><span>= </span><span style="color:#b48ead;">with </span><span style="color:#bf616a;">pkgs</span><span>; [</span><span style="color:#bf616a;">git ripgrep kitty starship </span><span style="color:#65737e;">/* ... */</span><span>];
</span><span>  </span><span style="color:#d08770;">node </span><span>= </span><span style="color:#b48ead;">with </span><span style="color:#bf616a;">pkgs</span><span>.</span><span style="color:#bf616a;">nodePackages_latest</span><span>; [</span><span style="color:#bf616a;">vscode-langservers-extracted </span><span style="color:#65737e;">/* ... */</span><span>];
</span><span>  </span><span style="color:#d08770;">beam </span><span>= </span><span style="color:#b48ead;">with </span><span style="color:#bf616a;">pkgs</span><span>.</span><span style="color:#bf616a;">beam27Packages</span><span>; [</span><span style="color:#bf616a;">elixir elixir-ls </span><span style="color:#65737e;">/* ... */</span><span>];
</span><span>
</span><span>  </span><span style="color:#65737e;"># ...and so on.
</span><span>}
</span></code></pre>
<h3 id="overlay-nix"><code>overlay.nix</code></h3>
<p>Sometimes, I want to override options for a package or apply fixes. Instead of doing this configuration in <code>packages.nix</code>, I do it in an overlay, so the same things are applied everywhere the packages are used. As an example, some nix options allow specifying the package to use (like <code>home.pointerCursor.package = ...</code>), and it would be easy to forget overrides here.</p>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span>self: super: {
</span><span>  </span><span style="color:#65737e;"># An example of a package I want to customize.
</span><span>  </span><span style="color:#d08770;">vesktop </span><span>= </span><span style="color:#bf616a;">super</span><span>.</span><span style="color:#bf616a;">vesktop</span><span>.</span><span style="color:#bf616a;">override </span><span>{
</span><span>    </span><span style="color:#d08770;">electron </span><span>= </span><span style="color:#bf616a;">self</span><span>.</span><span style="color:#bf616a;">electron_33</span><span>;
</span><span>    </span><span style="color:#d08770;">withTTS </span><span>= </span><span style="color:#d08770;">false</span><span>;
</span><span>  };
</span><span>}
</span></code></pre>
<h3 id="devshells-nix"><code>devshells.nix</code></h3>
<p>Most of the time, <code>nix-ld</code> lets me run unpatched binaries if I want to try something out. When I want to build something myself which requires specific packages or runtime libraries, I used to just create a <code>flake.nix</code> ad-hoc, which got annoying over time. I define some devshells here that cover the most common usecases and let me quickly get these dependencies into my path if I need them.</p>
<p>For example, I've been playing around with a lot of GUI libraries, which mostly have the same dependencies. This is the shell I created for those:</p>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span>pkgs: {
</span><span>  </span><span style="color:#d08770;">gui </span><span>= </span><span style="color:#bf616a;">pkgs</span><span>.</span><span style="color:#bf616a;">mkShell </span><span style="color:#b48ead;">rec </span><span>{
</span><span>    </span><span style="color:#d08770;">packages </span><span>= </span><span style="color:#b48ead;">with </span><span style="color:#bf616a;">pkgs</span><span>; [</span><span style="color:#bf616a;">libxkbcommon vulkan-loader wayland</span><span>];
</span><span>    </span><span style="color:#d08770;">LD_LIBRARY_PATH </span><span>= </span><span style="color:#bf616a;">pkgs</span><span>.</span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">makeLibraryPath packages</span><span>;
</span><span>  };
</span><span>}
</span></code></pre>
<p>By running <code>echo "use flake ~/.flake#&lt;name&gt;" &gt;&gt; .envrc &amp;&amp; direnv allow</code>, I'll have everything I need by default whenever I <code>cd</code> into the cloned project. This is instant most of the time, since it uses the same <code>nixpkgs</code> that are installed globally.</p>
<h3 id="host-specific-config-hosts-name-configuration-nix">Host-specific config (<code>hosts/&lt;name&gt;/configuration.nix</code>)</h3>
<p>These are pretty minimal and mostly hardware dependant. Here's an example:</p>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#8fa1b3;">{ </span><span>pkgs </span><span style="color:#8fa1b3;">}</span><span>: {
</span><span>  </span><span style="color:#65737e;"># Add nix-hardware modules
</span><span>  </span><span style="color:#d08770;">imports </span><span>= [
</span><span>    </span><span style="color:#bf616a;">inputs</span><span>.</span><span style="color:#bf616a;">nixos-hardware</span><span>.</span><span style="color:#bf616a;">nixosModules</span><span>.</span><span style="color:#bf616a;">common-cpu-amd
</span><span>    </span><span style="color:#bf616a;">inputs</span><span>.</span><span style="color:#bf616a;">nixos-hardware</span><span>.</span><span style="color:#bf616a;">nixosModules</span><span>.</span><span style="color:#bf616a;">common-cpu-amd-pstate
</span><span>    </span><span style="color:#bf616a;">inputs</span><span>.</span><span style="color:#bf616a;">nixos-hardware</span><span>.</span><span style="color:#bf616a;">nixosModules</span><span>.</span><span style="color:#bf616a;">common-gpu-amd
</span><span>    </span><span style="color:#bf616a;">inputs</span><span>.</span><span style="color:#bf616a;">nixos-hardware</span><span>.</span><span style="color:#bf616a;">nixosModules</span><span>.</span><span style="color:#bf616a;">common-pc-ssd
</span><span>  ];
</span><span>
</span><span>  </span><span style="color:#d08770;">networking </span><span>= {
</span><span>    </span><span style="color:#d08770;">hostId </span><span>= &quot;</span><span style="color:#a3be8c;">&lt;random id&gt;</span><span>&quot;;
</span><span>    </span><span style="color:#d08770;">hostName </span><span>= &quot;</span><span style="color:#a3be8c;">&lt;hostname&gt;</span><span>&quot;;
</span><span>  };
</span><span>
</span><span>  </span><span style="color:#65737e;"># Add kernel params and bootloader settings
</span><span>  </span><span style="color:#d08770;">boot </span><span>= {
</span><span>    </span><span style="color:#d08770;">loader</span><span>.</span><span style="color:#d08770;">systemd-boot</span><span>.</span><span style="color:#d08770;">enable </span><span>= </span><span style="color:#d08770;">true</span><span>;
</span><span>    </span><span style="color:#d08770;">kernelParams </span><span>= [</span><span style="color:#65737e;">/* ... */</span><span>];
</span><span>  };
</span><span>
</span><span>  </span><span style="color:#65737e;"># Make sure building a config doesn&#39;t use all CPU and I can keep working
</span><span>  </span><span style="color:#65737e;"># during the build. I adjust this based on the machine.
</span><span>  </span><span style="color:#d08770;">nix</span><span>.</span><span style="color:#d08770;">settings </span><span>= {
</span><span>    </span><span style="color:#d08770;">cores </span><span>= </span><span style="color:#d08770;">6</span><span>;
</span><span>    </span><span style="color:#d08770;">max-jobs </span><span>= </span><span style="color:#d08770;">4</span><span>;
</span><span>  };
</span><span>
</span><span>  </span><span style="color:#65737e;"># Not all my machines have bluetooth, so it&#39;s enabled here
</span><span>  </span><span style="color:#d08770;">hardware</span><span>.</span><span style="color:#d08770;">bluetooth</span><span>.</span><span style="color:#d08770;">enabled </span><span>= </span><span style="color:#d08770;">true</span><span>;
</span><span>
</span><span>  </span><span style="color:#65737e;"># And so on.
</span><span>}
</span></code></pre>
<p>The <code>hardware-configuration.nix</code> file is copied directly from what generates during installation.</p>
<h1 id="everyday-usage">Everyday Usage</h1>
<p>Let's go through some workflows to see how this setup makes my life easier. To apply the config, I have a <code>justfile</code> for which I have a global alias in my zsh config:</p>
<pre data-lang="zsh" style="background-color:#2b303b;color:#c0c5ce;" class="language-zsh "><code class="language-zsh" data-lang="zsh"><span style="color:#96b5b4;">alias </span><span style="color:#8fa1b3;">flake</span><span>=&quot;</span><span style="color:#a3be8c;">just -f ~/.flake/justfile </span><span>&quot;
</span></code></pre>
<p>Here's an excerpt from the <code>justfile</code>:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>set shell := [&quot;zsh&quot;, &quot;-c&quot;]
</span><span>alias a := apply
</span><span>
</span><span># Switch to the current flake configuration
</span><span>@apply:
</span><span>  git add .
</span><span>  sudo nixos-rebuild switch --flake ~/.flake#
</span></code></pre>
<p>So, installing a package would be done by adding it to <code>packages.nix</code> and then running <code>flake a</code>.</p>
<h4 id="updating-dotfiles">Updating dotfiles</h4>
<p>I just edit the dotfiles in <code>~/.flake/config</code>, and that's it. They are symlinked, so any changes are directly visible to the respective program.</p>
<h4 id="installing-nixos">Installing NixOS</h4>
<p>I start by booting into a NixOS live disk and formatting my drives. I'd eventually like to automate this completely using <a href="https://github.com/nix-community/disko"><code>disko</code></a> and <a href="https://github.com/nix-community/nixos-anywhere"><code>nixos-anywhere</code></a>, but I ran into some issues last time I tried.</p>
<p>Then, I clone the flake (<code>git clone https://github.com/happenslol/flake.git /home/happens/.flake</code>). If I'm adding a new host, I also generate a hardware config with <code>nixos-generate-config</code> and place it in a new host directory.</p>
<p>After running <code>nixos-install --flake /home/happens/.flake#&lt;hostname&gt;</code>, I can boot into the fully configured system. I have to log in as <code>root</code> once and change the password for the user - there's probably a way to set the password during installation, but it's not a big deal to me so I haven't put any work into it.</p>
<h4 id="running-binaries">Running Binaries</h4>
<p><code>nix-ld</code> and my devshells take care of most things I need to run. When building an external repo for which I don't have a devshell yet, I usually create a super minimal flake:</p>
<pre data-lang="nix" style="background-color:#2b303b;color:#c0c5ce;" class="language-nix "><code class="language-nix" data-lang="nix"><span>{
</span><span>  </span><span style="color:#d08770;">inputs</span><span>.</span><span style="color:#d08770;">nixpkgs</span><span>.</span><span style="color:#d08770;">url </span><span>= &quot;</span><span style="color:#a3be8c;">nixpkgs/nixos-unstable</span><span>&quot;;
</span><span>  </span><span style="color:#d08770;">outputs </span><span>= </span><span style="color:#8fa1b3;">{</span><span>nixpkgs, ...</span><span style="color:#8fa1b3;">}</span><span>: </span><span style="color:#b48ead;">let
</span><span>    </span><span style="color:#d08770;">system </span><span>= &quot;</span><span style="color:#a3be8c;">x86_64-linux</span><span>&quot;;
</span><span>    </span><span style="color:#d08770;">pkgs </span><span>= </span><span style="color:#96b5b4;">import </span><span style="color:#bf616a;">nixpkgs </span><span>{</span><span style="color:#b48ead;">inherit </span><span style="color:#d08770;">system</span><span>;};
</span><span>  </span><span style="color:#b48ead;">in </span><span>{
</span><span>    </span><span style="color:#d08770;">devShells</span><span>.</span><span style="font-style:italic;color:#ab7967;">${</span><span style="font-style:italic;color:#bf616a;">system</span><span style="font-style:italic;color:#ab7967;">}</span><span>.</span><span style="color:#d08770;">default </span><span>= {
</span><span>      </span><span style="color:#d08770;">packages </span><span>= [</span><span style="color:#65737e;">/* ... */</span><span>];
</span><span>      </span><span style="color:#d08770;">LD_LIBRARY_PATH </span><span>= </span><span style="color:#bf616a;">pkgs</span><span>.</span><span style="color:#bf616a;">lib</span><span>.</span><span style="color:#bf616a;">makeLibraryPath </span><span>[</span><span style="color:#65737e;">/* ... */</span><span>];
</span><span>    };
</span><span>  };
</span><span>}
</span></code></pre>
<p>As a last resort I use <code>steam-run</code>, which offers a full <code>fhsEnv</code> to processes.</p>
<p>This is still kind of a pain, honestly. I sometimes thinking about running a different distro and just using nix to manage my dotfiles and installed packages, so that I still have a full <code>fhsEnv</code> and can run dynamic binaries or build random repos like a normal person. For now, the benefits still outweigh the cons for me overall.</p>
<h4 id="updating-packages">Updating Packages</h4>
<p>Most of the time, running <code>nix flake update &amp;&amp; flake a</code> works without a problem. Rarely, I'll have to update some configuration or change the kernel version, but I haven't run into any huge issues here.</p>
<p>Even <em>more</em> rarely, the system will refuse to boot after an update, because of incompatible kernel packages or bugs in updated packages (like the greeter or compositor). In these cases, I mostly just boot to the last configuration, revert the update, and wait a few days before trying again. It's not too hard to track down these things and find the corresponding GitHub issues on <code>nixpkgs</code> that are usually already open - but <code>nixpkgs</code> moves very fast and breaking bugs aren't on unstable for more than a few days, in my experience.</p>
<p>The update experience for <code>NixOS</code> hasn't been much different to me than on other rolling distros like arch. The largest difference is that I can just reset everything if something breaks, and keep working.</p>
<h4 id="trying-out-packages">Trying Out Packages</h4>
<p>I recommend the amazing <a href="https://github.com/nix-community/comma"><code>comma</code></a> for running applications that you don't want to permanently install. Most packages are available in <code>nixpkgs</code>, and <code>comma</code> makes trying any of them out as easy as running <code>, &lt;package&gt;</code>.</p>
<h1 id="conclusion">Conclusion</h1>
<p>Maintaining a personal nix configuration can definitely be a hobby, and a very fun one at that. But over time, it's become important to me that I can engage in that hobby <em>when I want to</em>, and that I'm not required to do it in my everyday working life to be productive.<br />
With this config, I can keep on top of software updates and work on different machines that are synced with very little upkeep.</p>
<p>The upfront investment of switching to NixOS is certainly large, but the benefits have been invaluable to me. I switch machines daily, and change installed programs and my dotfiles frequently. Having everything stay in sync automatically saves me a ton of work. Just running <code>git pull &amp;&amp; flake a</code> on my laptop after not having used it for half a year, and having it <em>just work</em> and be up to date with my other machines was magical to me.<br />
Having a hard drive fail and being able to reinstall within 20 minutes after replacing it, picking up right where I left off, is something I couldn't have imagined back when using arch.</p>
<p>I hope my experience can be of use to anyone reading this! I'm happy about any comments, questions or suggestions.</p>
</article>
</div>


    </main>

    <script>
      updateModeIcon(getMode());
    </script>
  </body>
</html>
